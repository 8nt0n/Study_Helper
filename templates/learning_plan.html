<!-- Notes Modal -->
<div id="notesModal" class="modal" style="
    display:none; position:fixed; z-index:1000;
    left:0; top:0; width:100%; height:100%;
    background-color: rgba(0,0,0,0.7);">
  <div style="
      position:relative;
      margin:5% auto;
      background:#fff;
      padding:10px;
      width:80%;
      max-width:900px;
      border-radius:10px;">
    <span id="closeNotes" style="
        position:absolute; right:15px; top:10px;
        font-size:28px; font-weight:bold; cursor:pointer;">
      &times;
    </span>
    <iframe id="notesFrame"
            src=""
            style="width:100%; height:500px; border:none; border-radius:8px;"
            allowfullscreen>
    </iframe>
  </div>
</div>


<!-- Popup modal -->
<div id="videoModal" class="modal" style="
    display:none;
    position:fixed;
    z-index:1000;
    left:0; top:0;
    width:100%; height:100%;
    background-color: rgba(0,0,0,0.7);
    ">
  <div style="
      position:relative;
      margin:5% auto;
      background:#fff;
      padding:10px;
      width:80%;
      max-width:1000px;
      border-radius:10px;
  ">
    <span id="closeModal" style="
        position:absolute;
        right:15px;
        top:10px;
        font-size:28px;
        font-weight:bold;
        cursor:pointer;
        color: white;
    ">&times;</span>

    <!-- We‚Äôll inject the iframe src dynamically -->
    <iframe id="videoFrame"
            src=""
            frameborder="0"
            allow="autoplay; fullscreen"
            style="width:100%; height:500px; border-radius:8px;"
            allowfullscreen>
    </iframe>
  </div>
</div>

<h2>Learn {{ project[1] }}</h2>
<ul>
{% for chapter in plan['chapters'] %}
    {% set chapter_idx = loop.index0 %}
    <li>
        <strong>{{ chapter['title'] }}</strong><br>
        {{ chapter['summary'] }}
        <ul>
            {% for subtopic in chapter['subtopics'] %}
                {% set sub_idx = loop.index0 %}
                <li>
                    <b>{{ subtopic['title'] }}</b>: {{ subtopic['description'] }}

                    <div style="margin-bottom: 30px;">
                        <div style="margin-bottom: 30px;">
                            <!-- Unified resource buttons: use data- attributes not inline onclick -->
                            <button class="resource-btn" 
                                    data-type="video"
                                    data-chapter="{{ chapter_idx }}"
                                    data-sub="{{ sub_idx }}"
                                    data-title="{{ subtopic['title']|e }}"
                                    data-description="{{ subtopic['description']|e }}">
                            ‚ñ∂Ô∏è Video
                            </button>

                            <button class="resource-btn" 
                                    data-type="notes"
                                    data-chapter="{{ chapter_idx }}"
                                    data-sub="{{ sub_idx }}"
                                    data-title="{{ subtopic['title']|e }}"
                                    data-description="{{ subtopic['description']|e }}">
                            üìÑ Notes
                            </button>

                            <button class="resource-btn" 
                                    data-type="quiz"
                                    data-chapter="{{ chapter_idx }}"
                                    data-sub="{{ sub_idx }}"
                                    data-title="{{ subtopic['title']|e }}"
                                    data-description="{{ subtopic['description']|e }}">
                            ‚ùì Quiz
                            </button>
                        </div>

                    </div>
                </li>
            {% endfor %}
        </ul>
    </li>
{% endfor %}
</ul>
<script>
/* make these global so functions defined outside DOMContentLoaded can use them */
window.projectId = {{ project[0]|tojson }};
window.userId = {{ User_id|tojson }};

document.addEventListener('DOMContentLoaded', () => {
  // Attach listeners to data-* buttons
  document.querySelectorAll('.resource-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const type = btn.dataset.type;
      const chapter_idx = btn.dataset.chapter;
      const sub_idx = btn.dataset.sub;
      const title = btn.dataset.title;
      const description = btn.dataset.description;
      console.log("Button clicked", {type, chapter_idx, sub_idx, title});
      handleResource(type, chapter_idx, sub_idx, title, description, btn);
    });
  });

  // modal close handlers
  const closeModal = document.getElementById('closeModal');
  const closeNotes = document.getElementById('closeNotes');
  if (closeModal) closeModal.addEventListener('click', () => {
    document.getElementById('videoFrame').src = '';
    document.getElementById('videoModal').style.display = 'none';
  });
  if (closeNotes) closeNotes.addEventListener('click', () => {
    document.getElementById('notesFrame').src = '';
    document.getElementById('notesModal').style.display = 'none';
  });
  window.addEventListener('click', (ev) => {
    const vmodal = document.getElementById('videoModal');
    const nmodal = document.getElementById('notesModal');
    if (ev.target === vmodal) { document.getElementById('videoFrame').src=''; vmodal.style.display='none'; }
    if (ev.target === nmodal) { document.getElementById('notesFrame').src=''; nmodal.style.display='none'; }
  });
});

/* open viewers */
function openResourceViewer(type, url) {
  if (type === 'video') {
    const modal = document.getElementById('videoModal');
    const iframe = document.getElementById('videoFrame');
    iframe.src = url;
    modal.style.display = 'block';
  } else {
    const modal = document.getElementById('notesModal');
    const frame = document.getElementById('notesFrame');
    frame.src = url;
    modal.style.display = 'block';
  }
}

/* handleResource */
async function handleResource(type, chapter_idx, sub_idx, title, description, btn) {
  console.log("handleResource start", {type, chapter_idx, sub_idx, title});
  btn.disabled = true;
  const origText = btn.innerText;
  btn.innerText = "Loading‚Ä¶";

  try {
    // Status check
    const statusUrl = `/api/projects/${window.projectId}/resource/status?type=${encodeURIComponent(type)}&chapter_idx=${encodeURIComponent(chapter_idx)}&sub_idx=${encodeURIComponent(sub_idx)}`;
    console.log("fetch status", statusUrl);
    const statusResp = await fetch(statusUrl, { credentials: 'same-origin' });
    if (!statusResp.ok) {
      const txt = await statusResp.text();
      console.error("Status API error", statusResp.status, txt);
      alert("Status check failed (see console).");
      return;
    }
    const status = await statusResp.json();
    console.log("status result", status);

    if (status.exists) {
      openResourceViewer(type, status.url);
      return;
    }

    // Create
    const createUrl = `/api/projects/${window.projectId}/resource/create`;
    console.log("creating via", createUrl);
    const createResp = await fetch(createUrl, {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type, chapter_idx, sub_idx, title, description })
    });

    const createJson = await createResp.json().catch(e => { 
      console.error("failed to parse create response json", e);
      return null;
    });
    if (!createResp.ok) {
      console.error("Create failed", createResp.status, createJson);
      alert("Create failed (see console).");
      return;
    }
    console.log("create success", createJson);
    openResourceViewer(type, createJson.url);

  } catch (err) {
    console.error("handleResource exception", err);
    alert("An error occurred. See console for details.");
  } finally {
    btn.disabled = false;
    btn.innerText = origText;
  }
}
</script>
